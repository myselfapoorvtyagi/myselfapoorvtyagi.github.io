<svg width="1300" height="650" viewBox="0 0 1300 650" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#334155" />
    </marker>
  </defs>
  <rect width="1400" height="850" fill="#f8fafc" rx="20"/>
  <!-- Title -->
  <text x="50" y="40" font-size="22" font-weight="600" fill="#0f172a">
    Webhook → Cloud Function → BigQuery Pipeline (with Apigee, Secret Manager and Observability)
  </text>
  <text x="50" y="65" font-size="14" fill="#475569">
    Production-grade async workflow with caching, retries, and full monitoring integration
  </text>

  <!-- Webhook -->
  <rect x="60" y="150" width="160" height="80" rx="10" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"/>
  <text x="140" y="185" text-anchor="middle" font-size="14" fill="#0f172a">Webhook (External)</text>
  <text x="140" y="200" text-anchor="middle" font-size="12" fill="#64748b">Trigger event (JSON payload)</text>

  <!-- Apigee -->
  <rect x="270" y="130" width="160" height="120" rx="15" fill="#fef9c3" stroke="#ca8a04" stroke-width="2"/>
  <text x="350" y="165" text-anchor="middle" font-size="14" fill="#78350f">Apigee Edge</text>
  <text x="350" y="180" text-anchor="middle" font-size="12" fill="#92400e">Auth, quota, policies</text>
  <text x="350" y="195" text-anchor="middle" font-size="12" fill="#92400e">Token request routing</text>

  <!-- Secret Manager -->
  <rect x="270" y="290" width="160" height="80" rx="12" fill="#fce7f3" stroke="#be185d" stroke-width="2"/>
  <text x="350" y="325" text-anchor="middle" font-size="13" fill="#831843">Secret Manager</text>
  <text x="350" y="340" text-anchor="middle" font-size="12" fill="#9d174d">Secure token store + rotation</text>

  <!-- Cloud Function -->
  <rect x="480" y="120" width="200" height="120" rx="15" fill="#fde68a" stroke="#d97706" stroke-width="2"/>
  <text x="580" y="160" text-anchor="middle" font-size="14" fill="#78350f">Cloud Function</text>
  <text x="580" y="175" text-anchor="middle" font-size="12" fill="#92400e">Core pipeline logic</text>
  <text x="580" y="190" text-anchor="middle" font-size="12" fill="#92400e">Async retries ×3 + caching</text>

  <!-- Retry Queue -->
  <rect x="480" y="280" width="200" height="80" rx="12" fill="#dcfce7" stroke="#16a34a" stroke-width="2"/>
  <text x="580" y="315" text-anchor="middle" font-size="13" fill="#166534">Retry Queue (Pub/Sub)</text>
  <text x="580" y="330" text-anchor="middle" font-size="12" fill="#15803d">Exponential backoff x3</text>

  <!-- BigQuery -->
  <rect x="750" y="100" width="160" height="160" rx="15" fill="#93c5fd" stroke="#1d4ed8" stroke-width="2"/>
  <text x="830" y="145" text-anchor="middle" font-size="14" fill="#1e3a8a">BigQuery</text>
  <text x="830" y="165" text-anchor="middle" font-size="12" fill="#1e40af">Main and temp tables</text>
  <text x="830" y="180" text-anchor="middle" font-size="12" fill="#1e40af">+ Materialized views</text>

  <!-- Cloud Storage -->
  <rect x="750" y="290" width="160" height="80" rx="12" fill="#dbeafe" stroke="#1e3a8a" stroke-width="2"/>
  <text x="830" y="325" text-anchor="middle" font-size="13" fill="#1e3a8a">Cloud Storage</text>
  <text x="830" y="340" text-anchor="middle" font-size="12" fill="#1e40af">Intermediate exports</text>

  <!-- Monitoring -->
  <rect x="1010" y="100" width="200" height="100" rx="15" fill="#dcfce7" stroke="#16a34a" stroke-width="2"/>
  <text x="1110" y="140" text-anchor="middle" font-size="14" fill="#166534">Cloud Logging + Monitoring</text>
  <text x="1110" y="160" text-anchor="middle" font-size="12" fill="#15803d">Latency traces, alerts, dashboards</text>

  <!-- External API -->
  <rect x="1010" y="260" width="200" height="100" rx="15" fill="#fecaca" stroke="#dc2626" stroke-width="2"/>
  <text x="1110" y="295" text-anchor="middle" font-size="14" fill="#7f1d1d">External Partner API</text>
  <text x="1110" y="310" text-anchor="middle" font-size="12" fill="#991b1b">Approve / Reject endpoints</text>

  <!-- Arrows -->
  <line x1="220" y1="190" x2="270" y2="190" stroke="#334155" stroke-width="2" marker-end="url(#arrow)" />
  <line x1="430" y1="190" x2="480" y2="180" stroke="#334155" stroke-width="2" marker-end="url(#arrow)" />
  <line x1="680" y1="180" x2="750" y2="180" stroke="#334155" stroke-width="2" marker-end="url(#arrow)" />
  <line x1="910" y1="180" x2="1010" y2="180" stroke="#334155" stroke-width="2" marker-end="url(#arrow)" />
  <line x1="910" y1="180" x2="1010" y2="310" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrow)" stroke-dasharray="4"/>
  <line x1="580" y1="240" x2="580" y2="280" stroke="#16a34a" stroke-width="2" marker-end="url(#arrow)" />
  <line x1="350" y1="250" x2="350" y2="290" stroke="#be185d" stroke-width="2" marker-end="url(#arrow)" />

  <!-- Metrics & Notes -->
  <text x="60" y="500" font-size="14" fill="#16a34a">✅ p95 latency improved: 90s → 15s</text>
  <text x="60" y="520" font-size="14" fill="#0f766e">✅ 3 retries with exponential backoff</text>
  <text x="60" y="540" font-size="14" fill="#4b5563">✅ Secure token management via Secret Manager</text>
  <text x="60" y="560" font-size="14" fill="#0f172a">✅ End-to-end traceability with Logging + Monitoring</text>

</svg>
